<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Client Stream</title>
  <style>body { font-family: sans-serif; text-align: center; }</style>
</head>
<body>
  <h1>🎥 Client Stream</h1>
  <p>Nhập chuỗi kết nối để xem stream:</p>
  <textarea id="offerStringInput" rows="4" style="width: 80%; padding: 10px; font-size: 16px;"></textarea>
  <button onclick="connectStream()">Kết nối và xem stream</button>
  
  <br><br>
  <video id="video" width="600" controls autoplay></video>

  <script>
    const pc = new RTCPeerConnection();

    // Hàm kết nối và xem stream
    function connectStream() {
      const offerString = document.getElementById('offerStringInput').value;

      if (!offerString) {
        alert("Vui lòng nhập chuỗi kết nối!");
        return;
      }

      try {
        // Parse chuỗi JSON và thiết lập RemoteDescription
        const offer = JSON.parse(offerString);
        
        // Khi nhận track, gán stream vào video
        pc.ontrack = (event) => {
          console.log("Đã nhận track:", event.streams[0]);

          const videoElement = document.getElementById('video');
          // Gán stream vào video
          videoElement.srcObject = event.streams[0];

          // Kiểm tra xem video có thực sự nhận được stream không
          if (videoElement.srcObject) {
            console.log("Video đã nhận stream thành công.");
          } else {
            console.log("Không thể gán stream vào video.");
          }

          // Kiểm tra thêm một lần nữa nếu video chưa hiển thị
          if (videoElement.paused) {
            videoElement.play().then(() => {
              console.log("Video bắt đầu phát!");
            }).catch(error => {
              console.error("Lỗi khi bắt đầu phát video:", error);
            });
          }
        };

        // Thiết lập remote description từ offer
        pc.setRemoteDescription(offer).then(() => {
          console.log("Kết nối thành công và đang stream...");
        }).catch(error => {
          console.error("Lỗi khi thiết lập remote description:", error);
          alert("Lỗi khi thiết lập kết nối: " + error);
        });

        // Thêm ICE candidate nếu có
        pc.onicecandidate = (event) => {
          if (event.candidate) {
            console.log("ICE candidate:", event.candidate);
          }
        };

        // Xử lý trạng thái kết nối ICE
        pc.oniceconnectionstatechange = () => {
          console.log("ICE connection state change:", pc.iceConnectionState);
        };

      } catch (error) {
        alert("Lỗi khi kết nối: " + error);
        console.error("Lỗi parse chuỗi:", error);
      }
    }
  </script>
</body>
</html>
